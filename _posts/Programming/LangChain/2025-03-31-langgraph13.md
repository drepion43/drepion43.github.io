---
title:  "LangGraph(Simulation)"
categories: LangChain
tag: [theory, AI, LLM, LangChain, LangGraph, RAG]
toc: true
author_profile: false
sidebar:
    nav: "docs"
use_math: true
excerpt: Agent
comments: true
date: 2025-03-31
toc_sticky: true
---
í•˜ê¸°ì˜ ë‚´ìš©ì€ <a href="https://wikidocs.net/233801" target="_blank">LangChain ë…¸íŠ¸</a> ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

# Chatbot Simulation
chatbotì˜ ì„±ëŠ¥ì„ í‰ê°€í•  ë•Œ, ìˆ˜ë™ìœ¼ë¡œ ì§ì ‘ í•˜ë‚˜ì”© í‰ê°€í•˜ëŠ”ë°ì—ëŠ” êµ‰ì¥íˆ ë§ì€ ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤. ì´ë²ˆì ˆì—ì„œëŠ” ì´ chatbotì˜ ì„±ëŠ¥ì„ í‰ê°€í•  ë•Œ, í‰ê°€ ë˜í•œ LLMì˜ ì§ˆì˜ì™€ ë‹µë³€ì„ í†µí•´ ì¬í˜„í•˜ì—¬ chatbotì˜ ê¸°ëŠ¥ì„ ì˜¨ì „íˆ ì˜ ìˆ˜í–‰í•˜ê³  ìˆëŠ”ì§€ë¥¼ í™•ì¸í•´ë³¼ ìˆ˜ ìˆëŠ” simulationì„ êµ¬ìƒí•˜ì—¬ ê²€ì¦ì„ í•´ë³´ë„ë¡í•˜ê² ìŠµë‹ˆë‹¤. ì¦‰, ê°€ìƒ ì‚¬ìš©ìë¥¼ ë§Œë“¤ì–´ chatbotì˜ assistantì™€ ëŒ€í™” simulationì„ ë§Œë“¤ì–´ë³´ë„ë¡í•˜ê² ìŠµë‹ˆë‹¤.   

## ìƒë‹´ì‚¬ì™€ ê³ ê° simulation
ì´ë²ˆ simulationì€ ìƒë‹´ì‚¬ì™€ ê³ ê°ì´ ëŒ€í™”í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë§Œë“¤ì–´, ìƒë‹´ì‚¬ LLMê³¼ ê³ ê° LLMì´ ì„œë¡œ ëŒ€í™”í•˜ëŠ” ê³¼ì •ì„ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.    
ìš°ì„  ì´ë¥¼ LangGraphë¡œ ë‹´ì•„ë‚´ê¸° ìœ„í•´ Stateë¥¼ ì •ì˜í•˜ê² ìŠµë‹ˆë‹¤. StateëŠ” ë‹¤ë¥¸ ê±´ êµ³ì´ í•„ìš”ì—†ê³  ì„œë¡œ ëŒ€í™”ë‚´ìš©ì„ ë‹´ëŠ” message listë§Œ ê°€ì§€ê³  ìˆìœ¼ë©´ ë©ë‹ˆë‹¤.   
```python
from langgraph.graph.message import add_messages  
from typing import Annotated  
from typing_extensions import TypedDict  


# State ì •ì˜  
class State(TypedDict):  
    messages: Annotated[list, add_messages]  # ì‚¬ìš©ì - ìƒë‹´ì‚¬ ê°„ì˜ ëŒ€í™” ë©”ì‹œì§€  
```
### LLM

ê·¸ëŸ¼ ì´ë²ˆì—ëŠ” ìƒë‹´ì‚¬ LLMì„ ë§Œë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤. system promptingì„ í†µí•´ "ë„ˆëŠ” ê³ ê° ì§€ì›ì„ í•´ì£¼ëŠ” ìƒë‹´ì‚¬ì•¼"ë¼ê³  ì •ì˜ë¥¼ í•´ë‘ê² ìŠµë‹ˆë‹¤. ë˜í•œ, í™•ì‹¤í•œ ìƒë‹´ì‚¬ë¼ëŠ” ë„ë©”ì¸ì— ëŒ€í•œ ë‹µë³€ì„ ìœ„í•´ temperatureê°’ë„ 0.6ìœ¼ë¡œ ì§€ì •í•˜ê² ìŠµë‹ˆë‹¤.   

```python
from typing import List
from langchain_openai import ChatOpenAI  
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder  
from langchain_core.messages import HumanMessage, AIMessage, BaseMessage  
from langchain_core.output_parsers import StrOutputParser

def call_chatbot(messages: List[BaseMessage]) -> dict:  
    # LangChain ChatOpenAI ëª¨ë¸ì„ Agent ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
    prompt = ChatPromptTemplate.from_messages(  
        [  
            (  
                "system",  
                "You are a customer support agent for a grocery store. Answer in Korean.",  
            ),  
            MessagesPlaceholder(variable_name="messages"),  
        ]
    )
    model = ChatOpenAI(model="gpt-4o-mini", temperature=0.6)  
    chain = prompt | model | StrOutputParser()  
    return chain.invoke({"messages": messages})  
```

ì´ë²ˆì—ëŠ” ê³ ê° LLMì„ ë§Œë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤. system promptingì„ í†µí•´ "ì‹ì¬ë¡œ ë§ˆíŠ¸ì˜ ê³ ê°ì´ë©°, ì €ë²ˆë‹¬ì— êµ¬ë§¤í•œ ì–‘ë°°ì¶”ë¥¼ ëª¨ë‘ í™˜ë¶ˆë°›ê³ ì‹¶ì–´í•œë‹¤"ê³  ì •ì˜ë¥¼ í•´ë‘ê² ìŠµë‹ˆë‹¤.    
```python
def create_scenario(name: str, instructions: str):  
    # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì •ì˜: í•„ìš”ì— ë”°ë¼ ë³€ê²½  
    system_prompt_template = """You are a customer of a grocery store. 
    You are interacting with a user who is a customer support person.

    Your name is {name}.

    # Instructions:
    {instructions}

    [IMPORTANT]
    - When you are finished with the conversation, respond with a single word 'FINISHED'  
    - You must speak in Korean."""

    # ëŒ€í™” ë©”ì‹œì§€ì™€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ê²°í•©í•˜ì—¬ ì±„íŒ… í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì„ ìƒì„±í•©ë‹ˆë‹¤.  
    prompt = ChatPromptTemplate.from_messages(  
        [
            ("system", system_prompt_template),  
            MessagesPlaceholder(variable_name="messages"),  
        ]
    )

    # íŠ¹ì • ì‚¬ìš©ì ì´ë¦„ê³¼ ì§€ì‹œì‚¬í•­ì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡¬í”„íŠ¸ë¥¼ ë¶€ë¶„ì ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤.  
    prompt = prompt.partial(name=name, instructions=instructions)
    model = ChatOpenAI(model="gpt-4o-mini", temperature=0.6)
    simulated_user = prompt | model | StrOutputParser()
    return simulated_user

instructions = """You are trying to get a refund for cabbage that you bought.
You want them to give you ALL the money back. This purchase happened a month ago."""  

# ì‚¬ìš©ì ì´ë¦„ì„ ì •ì˜í•©ë‹ˆë‹¤.  
name = "Hanseong"  

simulated_user = create_scenario(name=name, instructions=instructions)
```

### Node and Edge
ì´ì œ ê³ ê°ê³¼ ìƒë‹´ì‚¬ì˜ LLMì„ ë§Œë“¤ì—ˆìœ¼ë‹ˆ LangGraphì˜ Nodeë¥¼ ë§Œë“¤ê² ìŠµë‹ˆë‹¤. NodeëŠ” ê³ ê° Node, ìƒë‹´ì‚¬ Node ì´ë ‡ê²Œ 2ê°œë§Œ ë§Œë“¤ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤. ìš°ì„  ìƒë‹´ì‚¬ì˜ Nodeë¥¼ ë§Œë“¤ê² ìŠµë‹ˆë‹¤. ìƒë‹´ì‚¬ NodeëŠ” ë“¤ì–´ì˜¨ Stateì˜ messages ë¶€ë¶„ì„ call_chatbotì¸ ìƒë‹´ì‚¬ LLMì— inputì„ ë„˜ê²¨ì¤€ í›„ ê·¸ ê²°ê³¼ë¥¼ ë°›ìœ¼ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.   

```python
def ai_assistant_node(state: State):  
    # ìƒë‹´ì‚¬ ì‘ë‹µ í˜¸ì¶œ
    ai_response = call_chatbot(state["messages"])  

    # AI ìƒë‹´ì‚¬ì˜ ì‘ë‹µì„ ë°˜í™˜  
    return {"messages": [("assistant", ai_response)]}  
```    

ì´ë²ˆì—” ê³ ê° Nodeë¥¼ ë§Œë“¤ê² ìŠµë‹ˆë‹¤. ì ì‹œ ìƒê°ì„ í•´ë³´ë©´, ëŒ€ë¶€ë¶„ ìƒë‹´ì‚¬ê°€ LLMì´ê³  ê³ ê°ì´ ì‚¬ìš©ìê°€ ë©ë‹ˆë‹¤. ì´ ë•Œ, LLMì´ ë±‰ì–´ë‚´ëŠ” ë‹µë³€ì„ historyë¡œ ë„£ì„ ë•Œ, **íƒ€ì…ì€ AIMessage**ê°€ ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ, ì‹œë‚˜ë¦¬ì˜¤ì˜ ê²½ìš° ì´ë¥¼ ì—­ìœ¼ë¡œ ìƒê°í•´ì•¼í•©ë‹ˆë‹¤. ì¦‰, ìƒë‹´ì‚¬ê°€ ì‚¬ìš©ìì´ê³  ê³ ê°ì´ LLMì´ë¼ê³  ìƒê°ì„ í•´ì•¼í•©ë‹ˆë‹¤. ê·¸ëŸ¼, **ì‚¬ìš©ìê°€ ë‚´ë±‰ì€ ë‹µë³€ì„ íƒ€ì…ì´ AIMessage**ë¡œ ë³€í™˜í•´ì¤˜ì•¼í•©ë‹ˆë‹¤. ë”°ë¼ì„œ, í•œ ë²ˆ swapì„ í•´ì¤˜ì•¼í•©ë‹ˆë‹¤. ì´ swapì„ êµ¬ì„±í•˜ëŠ” í•¨ìˆ˜ë„ ë§Œë“¤ê² ìŠµë‹ˆë‹¤. **HummanMessage $\rightarrow$ AIMessage, AIMessage $\rightarrow$ HumanMessage** ì´ë ‡ê²Œ ë³€ê²½ì„ í•´ì¤˜ì•¼í•©ë‹ˆë‹¤. ê·¸ í›„ ì‚¬ìš©ìì˜ LLMì— Historyë¥¼ Inputìœ¼ë¡œ ë„£ì–´ ê²°ê³¼ë¥¼ ì–»ì–´ë‚´ë©´ ë©ë‹ˆë‹¤.   
```python
def _swap_roles(messages):  
    # ë©”ì‹œì§€ì˜ ì—­í• ì„ êµí™˜: ì‹œë®¬ë ˆì´ì…˜ ì‚¬ìš©ì ë‹¨ê³„ì—ì„œ ë©”ì‹œì§€ íƒ€ì…ì„ AI -> Human, Human -> AI ë¡œ êµí™˜í•©ë‹ˆë‹¤.  
    new_messages = []
    for m in messages:
        print(m)
        if isinstance(m, AIMessage):  
            # AIMessage ì¸ ê²½ìš°, HumanMessage ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.  
            new_messages.append(HumanMessage(content=m.content))  
        else:  
            # HumanMessage ì¸ ê²½ìš°, AIMessage ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.  
            new_messages.append(AIMessage(content=m.content))
    return new_messages  

# ì‹œë®¬ë ˆì´ì…˜ëœ ì‚¬ìš©ì(Simulated User) ë…¸ë“œ ì •ì˜  
def simulated_user_node(state: State):  
    # ë©”ì‹œì§€ íƒ€ì…ì„ êµí™˜: AI -> Human, Human -> AI
    new_messages = _swap_roles(state["messages"])  

    # ì‹œë®¬ë ˆì´ì…˜ëœ ì‚¬ìš©ìë¥¼ í˜¸ì¶œ  
    response = simulated_user.invoke({"messages": new_messages})  
    return {"messages": [("user", response)]}  
```  

ê·¸ëŸ¼ ì´ì œ Node 2ê°œë¥¼ ëª¨ë‘ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ê³ ê°ê³¼ ìƒë‹´ì‚¬ê°€ ê³„ì† ì„œë¡œ ìƒí˜¸ì‘ìš©ì„ ì´ë£¨ì–´ì ¸ì•¼í•˜ë©°, ì €ì˜ ê²½ìš° ìƒí˜¸ì‘ìš© í•©ì¹œ ê²°ê³¼ê°€ 10ì´ìƒì´ë©´ ëŒ€í™”ë¥¼ ì¢…ë£Œí•˜ë„ë¡ í•˜ëŠ” conditional edgeë¥¼ ë§Œë“¤ê² ìŠµë‹ˆë‹¤. ê¸°ì¡´ ì‹œìŠ¤í…œì„ ë§Œë“¤ê±°ë¼ë©´, ëë‚˜ì§€ ì•Šì§€ë§Œ, ì €ëŠ” í…ŒìŠ¤íŠ¸ì´ë‹ˆ ê°•ì œ ì¢…ë£Œ ì¡°ê±´ì„ ê±°ëŠ” ê²ƒì…ë‹ˆë‹¤.   
```python
def should_continue(state: State):  
    # ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ì˜ ê¸¸ì´ê°€ 10ë³´ë‹¤ í¬ë©´ 'end'ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.  
    if len(state["messages"]) > 10:  
        return "end"  
    # ë§ˆì§€ë§‰ ë©”ì‹œì§€ì˜ ë‚´ìš©ì´ 'FINISHED'ë¼ë©´ 'end'ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.  
    elif state["messages"][-1].content == "FINISHED":  
        return "end"  
    # ìœ„ì˜ ì¡°ê±´ì— í•´ë‹¹í•˜ì§€ ì•Šìœ¼ë©´ 'continue'ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.  
    else:  
        return "continue"  
```

### Graph
ì´ì œ graphë¥¼ ë§Œë“¤ê² ìŠµë‹ˆë‹¤. Graphë¥¼ ë§Œë“¤ê³  ì»´íŒŒì¼ í•œ í›„, ì–´ë–»ê²Œ ë„ì‹í™”ê°€ ë˜ëŠ”ì§€ë„ í•¨ê»˜ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.   
```python
from langgraph.graph import END, StateGraph  
from langgraph.checkpoint.memory import MemorySaver

memory = MemorySaver()

workflow = StateGraph(State)

# Node
workflow.add_node("simulated_user", simulated_user_node)
workflow.add_node("ai_assistant", ai_assistant_node)

# edge
workflow.add_edge("ai_assistant", "simulated_user")
workflow.add_conditional_edges(
    "simulated_user",
    should_continue,
    {
        "end": END,
        "continue": "ai_assistant",
    }
)

workflow.set_entry_point("ai_assistant")

app = workflow.compile(checkpointer=memory)
```   

<div style="text-align : center;">
<img src="../../../assets/images/LangChain/2025-03-31-langgraph13/simulation1.jpeg" alt="simulation1" style="zoom:150%;" />    
</div>    

ì¶œë ¥ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.   
```python
from langchain_core.runnables import RunnableConfig
from stream import *

# stream function

inputs = State(messages=[("user", "ì•ˆë…•í•˜ì„¸ìš”? ì € ì§€ê¸ˆ ì¢€ í™”ê°€ ë§ì´ ë‚¬ìŠµë‹ˆë‹¤^^")])
node_names = ["simulated_user" ,"ai_assistant"]
# config ì„¤ì •(ì¬ê·€ ìµœëŒ€ íšŸìˆ˜, thread_id)
config = RunnableConfig(recursion_limit=20, configurable={"thread_id": "1"})

streamer(app=app, inputs=inputs, config=config, node_names=node_names)
```

```bash
==================================================
ğŸ”„ Node: ai_assistant ğŸ”„
- - - - - - - - - - - - - - - - - - - - - - - - - 
ì•ˆë…•í•˜ì„¸ìš”! ê³ ê°ë‹˜, ë¬´ì—‡ ë•Œë¬¸ì— í™”ê°€ ë‚˜ì…¨ëŠ”ì§€ ë§ì”€í•´ ì£¼ì‹œë©´ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ì–´ë–¤ ë¬¸ì œê°€ ìˆìœ¼ì‹ ê°€ìš”?
==================================================
ğŸ”„ Node: simulated_user ğŸ”„
- - - - - - - - - - - - - - - - - - - - - - - - - 
í•œ ë‹¬ ì „ì— ì‚¬ì˜¨ ì–‘ë°°ì¶”ì— ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ í™˜ë¶ˆì„ ë°›ê³  ì‹¶ì–´ìš”. ì „ì•¡ í™˜ë¶ˆì´ ê°€ëŠ¥í• ê¹Œìš”?
==================================================
ğŸ”„ Node: ai_assistant ğŸ”„
- - - - - - - - - - - - - - - - - - - - - - - - - 
ê³ ê°ë‹˜, ì–‘ë°°ì¶”ì— ë¬¸ì œê°€ ìƒê¸°ì…¨ë‹¤ë‹ˆ ì •ë§ ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ, ì‹ ì„ ì‹í’ˆì˜ ê²½ìš° êµ¬ì… í›„ ì¼ì • ê¸°ê°„ ë‚´ì— ë¬¸ì œê°€ ë°œìƒí–ˆì„ ë•Œ í™˜ë¶ˆì´ ê°€ëŠ¥í•˜ì§€ë§Œ, í•œ ë‹¬ì´ ì§€ë‚¬ë‹¤ë©´ í™˜ë¶ˆì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ê³ ê°ë‹˜ì˜ ìƒí™©ì„ ê³ ë ¤í•˜ì—¬ ìµœëŒ€í•œ ë„ì™€ë“œë¦¬ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. êµ¬ë§¤ ì˜ìˆ˜ì¦ì´ë‚˜ ì‚¬ì§„ì„ ê°€ì§€ê³  ì˜¤ì‹œë©´ ë”ìš± ì›í™œí•˜ê²Œ ì²˜ë¦¬í•´ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§¤ì¥ì— ë°©ë¬¸í•˜ì‹œê² ì–´ìš”, ì•„ë‹ˆë©´ ì „í™”ë¡œ ìƒë‹´ì„ ì›í•˜ì‹œë‚˜ìš”?
==================================================
ğŸ”„ Node: simulated_user ğŸ”„
- - - - - - - - - - - - - - - - - - - - - - - - - 
ì˜ìˆ˜ì¦ì€ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ë§¤ì¥ì— ì§ì ‘ ê°€ì„œ í™˜ë¶ˆ ìš”ì²­ì„ í•˜ë ¤ê³  í•©ë‹ˆë‹¤. í•œ ë‹¬ì´ ì§€ë‚¬ì§€ë§Œ, ì „ì•¡ í™˜ë¶ˆì„ ê¼­ ë°›ê³  ì‹¶ìŠµë‹ˆë‹¤. ê°€ëŠ¥í•œê°€ìš”?
==================================================
ğŸ”„ Node: ai_assistant ğŸ”„
- - - - - - - - - - - - - - - - - - - - - - - - - 
ê³ ê°ë‹˜, ì˜ìˆ˜ì¦ì„ ê°€ì§€ê³  ê³„ì‹œë‹¤ë©´ ë§¤ì¥ì—ì„œ í™˜ë¶ˆ ìš”ì²­ì„ í•˜ì‹¤ ë•Œ ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤. í•œ ë‹¬ì´ ì§€ë‚¬ë”ë¼ë„ ìƒí™©ì— ë”°ë¼ ì „ì•¡ í™˜ë¶ˆì´ ê°€ëŠ¥í•  ìˆ˜ ìˆìœ¼ë‹ˆ, ë§¤ì¥ ì§ì›ì—ê²Œ ë¬¸ì˜í•´ ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤. ê³ ê°ë‹˜ì˜ ìƒí™©ì„ ì˜ ì„¤ëª…í•˜ì‹œë©´ ë”ìš± ì›í™œí•˜ê²Œ ì§„í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§¤ì¥ì— ë°©ë¬¸í•˜ì‹¤ ë•Œ, ë‹¤ë¥¸ ë„ì›€ì´ í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“ ì§€ ë§ì”€í•´ ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤!
==================================================
ğŸ”„ Node: simulated_user ğŸ”„
- - - - - - - - - - - - - - - - - - - - - - - - - 
ì•Œê² ìŠµë‹ˆë‹¤. ë§¤ì¥ì— ê°€ì„œ ì˜ ì„¤ëª…í•´ ë³´ê² ìŠµë‹ˆë‹¤. ì œê°€ ì›í•˜ëŠ” ì „ì•¡ í™˜ë¶ˆì´ ë  ìˆ˜ ìˆê¸°ë¥¼ ë°”ëë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤! 
...
ğŸ”„ Node: simulated_user ğŸ”„
- - - - - - - - - - - - - - - - - - - - - - - - - 
ë„¤, ê°ì‚¬í•©ë‹ˆë‹¤! í•„ìš”í•  ë•Œ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤. 

FINISHED
```

